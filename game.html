<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Custer Dash ‚Äî WFL</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .hud { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .hud span { display:inline-block; padding:6px 10px; border:1px solid var(--border); border-radius:12px; background:#0b1220; }
    canvas { width:100%; max-width: 980px; border:1px solid var(--border); border-radius:14px; background:#0b1220; display:block; }
    .hint { font-size:12px; color:var(--muted); margin-top:10px; }
    .btnrow { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    button{
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#0b1220;
      color:var(--text);
      cursor:pointer;
      font-weight:900;
    }
    button:hover{ border-color: var(--link); }
  </style>
</head>

<body>
  <header>
    <h1>WFL HUB</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="schedule.html">Schedule</a>
      <a href="news.html">News</a>
      <a href="quiz.html">Quiz</a>
      <a href="fan-activity.html">Fan Activity</a>
<a href="arcade.html">Arcade</a>
    </nav>
  </header>

  <main class="wrap">
    <div class="card">
      <h2>Custer Dash</h2>

      <div class="hud">
        <span><strong>Score:</strong> <span id="score">0</span></span>
        <span><strong>High:</strong> <span id="high">0</span></span>
        <span><strong>Speed:</strong> <span id="spd">1.0x</span></span>
        <span><strong>Status:</strong> <span id="status">Menu</span></span>
        <span><strong>Shield:</strong> <span id="shield">Off</span></span>
        <span><strong>Boots:</strong> <span id="boots">Off</span></span>
      </div>

      <div class="btnrow">
        <button id="btnStart">Start / Restart</button>
        <button id="btnPause">Pause</button>
        <button id="btnShare">Share score</button>
      </div>

      <p class="hint">
        Controls: <strong>Space / ‚Üë / Click / Tap</strong> to jump ‚Ä¢ <strong>‚Üì</strong> to slide ‚Ä¢ <strong>P</strong> to pause.
        Powerups: <strong>Shield</strong> blocks one hit ‚Ä¢ <strong>Boots</strong> = turbo burst.
      </p>

      <canvas id="c" width="980" height="420"></canvas>
    </div>
  </main>

<script>
(() => {
  // ---------- Canvas / UI ----------
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");

  const scoreEl  = document.getElementById("score");
  const highEl   = document.getElementById("high");
  const spdEl    = document.getElementById("spd");
  const statusEl = document.getElementById("status");
  const shieldEl = document.getElementById("shield");
  const bootsEl  = document.getElementById("boots");

  const btnStart = document.getElementById("btnStart");
  const btnPause = document.getElementById("btnPause");
  const btnShare = document.getElementById("btnShare");

  // ---------- Helpers ----------
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const rand  = (a,b)=>a+Math.random()*(b-a);
  const choice = (arr)=>arr[(Math.random()*arr.length)|0];

  function aabb(ax, ay, aw, ah, bx, by, bw, bh) {
    return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
  }

  // ---------- Game Settings ----------
  const W = canvas.width;
  const H = canvas.height;

  const groundY = 332;
  const gravity = 2350;
  const jumpVel = 910;
  const slideDuration = 0.55;

  const baseSpeed = 410;
  const speedGain = 15;

  const spawnBase = 1.02;
  const spawnMin  = 0.52;

  const powerSpawnBase = 3.1;
  const powerSpawnMin  = 2.1;

  // ---------- State ----------
  let state = "menu"; // menu | playing | paused | gameover
  let tPrev = performance.now();

  let scoreFloat = 0;
  let score = 0;
  let high = Number(localStorage.getItem("custer_dash_high") || 0);

  let speed = baseSpeed;
  let spawnTimer = 0;
  let spawnEvery = spawnBase;

  let powerTimer = 0;
  let powerEvery = powerSpawnBase;

  // stadium scroll layers
  let bgCrowd = 0, bgBanners = 0, bgField = 0;

  // Power status
  let shield = 0;      // 0/1
  let bootsT = 0;      // seconds remaining
  let bootsMult = 1;   // multiplier

  // ---------- Start Menu Image ----------
  // Upload your image to: assets/custer.png
  const heroImg = new Image();
  heroImg.src = "assets/custer.png";
  let heroLoaded = false;
  heroImg.onload = () => heroLoaded = true;

  // ---------- Player ----------
  const player = {
    x: 160,
    y: groundY - 72,
    w: 46,
    h: 72,
    vy: 0,
    onGround: true,
    sliding: false,
    slideT: 0,
    animT: 0
  };

  function playerBox() {
    const pad = 7;
    return { x: player.x+pad, y: player.y+pad, w: player.w-pad*2, h: player.h-pad*2 };
  }

  function effectiveSpeed() {
    return speed * bootsMult;
  }

  function syncUI() {
    scoreEl.textContent = score.toString();
    highEl.textContent = high.toString();
    spdEl.textContent = (effectiveSpeed() / baseSpeed).toFixed(1) + "x";

    statusEl.textContent =
      state === "menu" ? "Menu" :
      state === "playing" ? (player.sliding ? "Sliding" : "Playing") :
      state === "paused" ? "Paused" : "Game Over";

    shieldEl.textContent = shield ? "On" : "Off";
    bootsEl.textContent = bootsT > 0 ? "On" : "Off";
  }

  function resetRun() {
    scoreFloat = 0;
    score = 0;

    speed = baseSpeed;
    spawnTimer = 0;
    spawnEvery = spawnBase;

    powerTimer = 0;
    powerEvery = powerSpawnBase;

    obstacles.length = 0;
    pickups.length = 0;

    bgCrowd = 0; bgBanners = 0; bgField = 0;

    shield = 0;
    bootsT = 0;
    bootsMult = 1;

    player.y = groundY - 72;
    player.vy = 0;
    player.onGround = true;
    player.sliding = false;
    player.slideT = 0;
    player.animT = 0;
  }

  function startGame() {
    resetRun();
    state = "playing";
    syncUI();
  }

  function gameOver() {
    state = "gameover";
    if (score > high) {
      high = score;
      localStorage.setItem("custer_dash_high", String(high));
    }
    syncUI();
  }

  function togglePause() {
    if (state === "playing") state = "paused";
    else if (state === "paused") state = "playing";
    syncUI();
  }

  // ---------- Obstacles: Football Players (Defenders) ----------
  const obstacles = [];

  function spawnDefender() {
    // Types: low tackle (jump), high hit (slide), normal
    const type = choice(["tackleLow", "hitHigh", "normal"]);
    const o = { type, x: W + 40, y: 0, w: 44, h: 70, anim: rand(0, 10) };

    if (type === "tackleLow") {
      o.h = 52; o.w = 52;
      o.y = groundY - o.h;
    } else if (type === "hitHigh") {
      // ‚Äúhigh‚Äù collision zone; forces slide
      o.h = 64; o.w = 44;
      o.y = groundY - o.h;
      o.hitHigh = true;
    } else {
      o.h = 70; o.w = 44;
      o.y = groundY - o.h;
    }

    const last = obstacles[obstacles.length - 1];
    if (last && (W + 40) - last.x < 170) return;

    obstacles.push(o);
  }

  function obstacleHitbox(o) {
    // Fair hitboxes
    if (o.type === "hitHigh") {
      // collide mostly upper chest/helmet zone (so slide avoids)
      return { x: o.x + 8, y: o.y + 6, w: o.w - 16, h: o.h - 30 };
    }
    if (o.type === "tackleLow") {
      return { x: o.x + 8, y: o.y + 16, w: o.w - 16, h: o.h - 18 };
    }
    return { x: o.x + 7, y: o.y + 7, w: o.w - 14, h: o.h - 14 };
  }

  // ---------- Pickups (Power-ups) ----------
  const pickups = [];

  function spawnPickup() {
    const type = choice(["shield", "boots"]); // boots = speed boots
    const p = { type, x: W + 40, y: 0, w: 30, h: 30, bob: rand(0, Math.PI*2) };

    // place on ground or in jump lane
    p.y = (Math.random() < 0.55) ? (groundY - p.h - 10) : (groundY - 120);

    pickups.push(p);
  }

  function pickupHitbox(p) {
    return { x: p.x + 3, y: p.y + 3, w: p.w - 6, h: p.h - 6 };
  }

  function applyPickup(type) {
    if (type === "shield") shield = 1;
    if (type === "boots") { bootsT = 2.4; bootsMult = 1.38; }
    syncUI();
  }

  // ---------- Input ----------
  function jump() {
    if (state === "menu") { startGame(); return; }
    if (state === "gameover") { startGame(); return; }
    if (state !== "playing") return;

    if (player.onGround && !player.sliding) {
      player.vy = -jumpVel;
      player.onGround = false;
    }
  }

  function slide() {
    if (state !== "playing") return;
    if (player.onGround && !player.sliding) {
      player.sliding = true;
      player.slideT = slideDuration;
      player.h = 52;
      player.y = groundY - player.h;
    }
  }

  window.addEventListener("keydown", (e) => {
    if (e.code === "Space" || e.code === "ArrowUp") { e.preventDefault(); jump(); }
    if (e.code === "ArrowDown") { e.preventDefault(); slide(); }
    if (e.code === "KeyP") { e.preventDefault(); if (state !== "menu") togglePause(); }
  });

  canvas.addEventListener("pointerdown", () => jump());

  btnStart.addEventListener("click", () => startGame());
  btnPause.addEventListener("click", () => { if (state !== "menu") togglePause(); });

  btnShare.addEventListener("click", async () => {
    const url = "https://thefutureworld2055-cyber.github.io/wfl-hub/game.html";
    const text = `I scored ${score} in Custer Dash üèàüî• Beat me: ${url}`;
    if (navigator.share) {
      try { await navigator.share({ title: "Custer Dash", text, url }); return; } catch {}
    }
    try { await navigator.clipboard.writeText(text); alert("Copied to clipboard!"); } catch { alert(text); }
  });

  // ---------- Drawing: Stadium Background ----------
  function drawStadium(dt) {
    const sp = (state === "playing") ? effectiveSpeed() : baseSpeed * 0.08;

    bgCrowd   = (bgCrowd   - sp * 0.05 * dt) % W;
    bgBanners = (bgBanners - sp * 0.10 * dt) % W;
    bgField   = (bgField   - sp * 0.30 * dt) % W;

    // sky
    ctx.fillStyle = "#050b18";
    ctx.fillRect(0, 0, W, H);

    // upper stadium / roof band
    ctx.fillStyle = "#0a1531";
    ctx.fillRect(0, 0, W, 70);

    // lights
    ctx.fillStyle = "#1a2b55";
    for (let x = bgBanners; x < W + 220; x += 220) {
      ctx.fillRect(x, 14, 14, 90);
      ctx.globalAlpha = 0.22;
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(x - 34, 10, 86, 10);
      ctx.globalAlpha = 1;
      ctx.fillStyle = "#1a2b55";
    }

    // scoreboard
    ctx.fillStyle = "#0b1220";
    ctx.fillRect(W - 230, 18, 200, 44);
    ctx.strokeStyle = "#1f2c46";
    ctx.strokeRect(W - 230, 18, 200, 44);
    ctx.fillStyle = "#ffffff";
    ctx.globalAlpha = 0.85;
    ctx.font = "14px sans-serif";
    ctx.fillText("CUSTER DASH", W - 216, 38);
    ctx.globalAlpha = 0.65;
    ctx.fillText("WFL", W - 216, 56);
    ctx.globalAlpha = 1;

    // crowd layers (fans as pixels)
    ctx.fillStyle = "#0c1f46";
    ctx.fillRect(0, 80, W, 95);

    ctx.globalAlpha = 0.70;
    for (let x = (bgCrowd * -1) % 14; x < W; x += 14) {
      const y = 92 + ((x/14|0)%3)*16;
      ctx.fillStyle = (x % 56 === 0) ? "#1d3b7a" : (x % 28 === 0 ? "#16315f" : "#102a52");
      ctx.fillRect(x, y, 10, 10);
      // occasional ‚Äúorange shirt‚Äù
      if (x % 98 === 0) { ctx.fillStyle = "#f08a1a"; ctx.fillRect(x+2, y+2, 6, 6); }
    }
    ctx.globalAlpha = 1;

    // banners
    for (let x = bgBanners; x < W + 240; x += 240) {
      ctx.fillStyle = "#2a0f56";
      ctx.fillRect(x, 175, 160, 18);
      ctx.fillStyle = "#f08a1a";
      ctx.fillRect(x+6, 179, 148, 10);
    }

    // field base
    ctx.fillStyle = "#03132a";
    ctx.fillRect(0, groundY, W, H - groundY);

    // turf stripes
    ctx.globalAlpha = 0.35;
    for (let i = 0; i < 12; i++) {
      ctx.fillStyle = i % 2 === 0 ? "#062b59" : "#05264e";
      ctx.fillRect(i * (W / 12), groundY, (W / 12), H - groundY);
    }
    ctx.globalAlpha = 1;

    // yard lines
    const spacing = 88;
    const offset = (bgField * -1) % spacing;

    ctx.fillStyle = "#d7e6ff";
    ctx.globalAlpha = 0.72;
    for (let x = offset; x < W; x += spacing) {
      ctx.fillRect(x, groundY + 16, 4, 62);
      ctx.globalAlpha = 0.35;
      ctx.fillRect(x + 10, groundY + 86, 14, 8);
      ctx.globalAlpha = 0.72;
    }
    ctx.globalAlpha = 1;

    // line
    ctx.fillStyle = "#123b79";
    ctx.fillRect(0, groundY, W, 3);
  }

  // ---------- Draw Player (SNES-ish blocks) ----------
  function drawPlayer(dt) {
    player.animT += dt;

    const runPhase = (state === "playing" && player.onGround && !player.sliding) ? player.animT * 14 : 0;
    const bob = (state === "playing" && player.onGround && !player.sliding) ? Math.sin(runPhase) * 2 : 0;

    const legSwing = (state === "playing" && player.onGround && !player.sliding) ? Math.sin(runPhase) * 6 : 0;
    const armSwing = (state === "playing" && player.onGround && !player.sliding) ? Math.sin(runPhase + Math.PI) * 5 : 0;

    const x = player.x;
    const y = player.y + bob;

    // palette (your request)
    const skin   = "#4b2a1a";
    const jersey = "#2a0f56";
    const helmet = "#3a1475";
    const orange = "#f08a1a";
    const pants  = "#e8eef7";
    const shadow = "#0b0f1b";

    // shadow
    ctx.fillStyle = shadow;
    ctx.globalAlpha = 0.35;
    ctx.fillRect(x + 6, groundY + 8, 40, 10);
    ctx.globalAlpha = 1;

    const w = player.w;
    const h = player.h;

    // legs
    ctx.fillStyle = pants;
    ctx.fillRect(x + 12 + legSwing*0.10, y + h - 26, 10, 20);
    ctx.fillRect(x + 24 - legSwing*0.10, y + h - 26, 10, 20);

    // orange stripe
    ctx.fillStyle = orange;
    ctx.fillRect(x + 22, y + h - 26, 4, 20);

    // shoes
    ctx.fillStyle = "#0a0a0a";
    ctx.fillRect(x + 11, y + h - 8, 12, 8);
    ctx.fillRect(x + 23, y + h - 8, 12, 8);

    // torso
    ctx.fillStyle = jersey;
    ctx.fillRect(x + 10, y + 24, 28, 26);

    // shoulder highlight
    ctx.fillStyle = orange;
    ctx.fillRect(x + 10, y + 26, 7, 8);

    // arms
    ctx.fillStyle = skin;
    ctx.fillRect(x + 32, y + 30 + armSwing*0.08, 8, 14);  // back arm
    ctx.fillRect(x + 6,  y + 28 - armSwing*0.08, 8, 16);  // front arm

    // gloves
    ctx.fillStyle = "#1a1a1a";
    ctx.fillRect(x + 5,  y + 40 - armSwing*0.08, 10, 6);
    ctx.fillRect(x + 31, y + 40 + armSwing*0.08, 10, 6);

    // helmet
    ctx.fillStyle = helmet;
    ctx.fillRect(x + 10, y + 6, 28, 20);

    // face opening (front/right)
    ctx.fillStyle = skin;
    ctx.fillRect(x + 26, y + 12, 10, 10);

    // facemask
    ctx.fillStyle = orange;
    ctx.fillRect(x + 20, y + 16, 14, 3);
    ctx.fillRect(x + 35, y + 12, 3, 10);

    // visor highlight
    ctx.fillStyle = "#ffffff";
    ctx.globalAlpha = 0.22;
    ctx.fillRect(x + 26, y + 8, 10, 3);
    ctx.globalAlpha = 1;

    // Jersey number "1"
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(x + 22, y + 28, 4, 18);
    ctx.fillStyle = orange;
    ctx.fillRect(x + 21, y + 28, 6, 2);
    ctx.fillRect(x + 21, y + 44, 6, 2);

    // Shield ring effect
    if (shield) {
      ctx.globalAlpha = 0.20;
      ctx.strokeStyle = "#9ad1ff";
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.arc(x + w/2, y + h/2, 34, 0, Math.PI*2);
      ctx.stroke();
      ctx.globalAlpha = 1;
    }
  }

  // ---------- Draw Defenders (Football obstacles) ----------
  function drawDefender(o, dt) {
    o.anim += dt;
    const bob = Math.sin(o.anim * 10) * 1.5;

    const x = o.x;
    const y = o.y + bob;

    // defender palette (contrasting)
    const helm = "#1b1f2a";
    const uni  = "#0d4a2a";
    const acc  = "#d7e6ff";
    const skin = "#3a251a";

    // shadow
    ctx.globalAlpha = 0.25;
    ctx.fillStyle = "#0b0f1b";
    ctx.fillRect(x + 6, groundY + 10, o.w - 12, 8);
    ctx.globalAlpha = 1;

    // legs
    ctx.fillStyle = "#2a2a2a";
    ctx.fillRect(x + 10, y + o.h - 22, 10, 16);
    ctx.fillRect(x + 24, y + o.h - 22, 10, 16);

    // torso
    ctx.fillStyle = uni;
    ctx.fillRect(x + 8, y + 22, o.w - 16, 26);

    // number block
    ctx.globalAlpha = 0.6;
    ctx.fillStyle = acc;
    ctx.fillRect(x + 18, y + 28, 8, 16);
    ctx.globalAlpha = 1;

    // arms
    ctx.fillStyle = skin;
    ctx.fillRect(x + 4, y + 28, 8, 16);
    ctx.fillRect(x + o.w - 12, y + 28, 8, 16);

    // helmet
    ctx.fillStyle = helm;
    ctx.fillRect(x + 10, y + 6, o.w - 20, 18);

    // facemask
    ctx.fillStyle = acc;
    ctx.globalAlpha = 0.65;
    ctx.fillRect(x + 12, y + 16, o.w - 24, 3);
    ctx.globalAlpha = 1;

    // type indicator (subtle)
    if (o.type === "hitHigh") {
      ctx.globalAlpha = 0.35;
      ctx.fillStyle = "#f08a1a";
      ctx.fillRect(x + 8, y + 12, o.w - 16, 4);
      ctx.globalAlpha = 1;
    }
    if (o.type === "tackleLow") {
      ctx.globalAlpha = 0.35;
      ctx.fillStyle = "#f08a1a";
      ctx.fillRect(x + 8, y + o.h - 18, o.w - 16, 4);
      ctx.globalAlpha = 1;
    }
  }

  // ---------- Power-ups (clear icons) ----------
  function drawPickup(p, dt) {
    p.bob += dt * 3;
    const y = p.y + Math.sin(p.bob) * 2;

    if (p.type === "shield") {
      // Blue badge shield
      ctx.fillStyle = "#2a5bd6";
      ctx.fillRect(p.x, y, p.w, p.h);
      ctx.globalAlpha = 0.85;
      ctx.fillStyle = "#9ad1ff";
      ctx.fillRect(p.x + 5, y + 4, p.w - 10, p.h - 8);
      ctx.globalAlpha = 1;
      ctx.fillStyle = "#071022";
      ctx.fillRect(p.x + 10, y + 8, p.w - 20, p.h - 16);
      ctx.fillStyle = "#9ad1ff";
      ctx.fillRect(p.x + 13, y + 11, p.w - 26, p.h - 22);
    } else {
      // Boots: orange boot icon
      ctx.fillStyle = "#f08a1a";
      ctx.fillRect(p.x, y, p.w, p.h);
      ctx.fillStyle = "#071022";
      // boot shape
      ctx.fillRect(p.x + 8, y + 7, 10, 14);
      ctx.fillRect(p.x + 18, y + 16, 8, 5);
      ctx.fillStyle = "#d7e6ff";
      ctx.globalAlpha = 0.7;
      ctx.fillRect(p.x + 8, y + 21, 18, 3); // sole
      ctx.globalAlpha = 1;
    }
  }

  // ---------- Menu Overlay ----------
  function drawMenuOverlay() {
    // dim
    ctx.globalAlpha = 0.78;
    ctx.fillStyle = "#050b18";
    ctx.fillRect(0, 0, W, H);
    ctx.globalAlpha = 1;

    // title
    ctx.fillStyle = "#ffffff";
    ctx.globalAlpha = 0.95;
    ctx.font = "52px sans-serif";
    ctx.fillText("Custer Dash", 60, 90);

    ctx.globalAlpha = 0.75;
    ctx.font = "18px sans-serif";
    ctx.fillText("Click / Space to start ‚Ä¢ ‚Üë jump ‚Ä¢ ‚Üì slide ‚Ä¢ Grab Shield + Boots", 60, 122);
    ctx.globalAlpha = 1;

    // image card
    const cardX = 60, cardY = 150, cardW = 360, cardH = 240;
    ctx.fillStyle = "#0b1220";
    ctx.fillRect(cardX, cardY, cardW, cardH);
    ctx.strokeStyle = "#1f2c46";
    ctx.strokeRect(cardX, cardY, cardW, cardH);

    if (heroLoaded) {
      // contain image in card
      const iw = heroImg.width, ih = heroImg.height;
      const scale = Math.min((cardW-20)/iw, (cardH-20)/ih);
      const dw = iw * scale, dh = ih * scale;
      const dx = cardX + (cardW - dw)/2;
      const dy = cardY + (cardH - dh)/2;
      ctx.drawImage(heroImg, dx, dy, dw, dh);
    } else {
      ctx.fillStyle = "#ffffff";
      ctx.globalAlpha = 0.7;
      ctx.font = "16px sans-serif";
      ctx.fillText("Loading image...", cardX + 18, cardY + 40);
      ctx.globalAlpha = 1;
    }

    // right side info
    ctx.fillStyle = "#ffffff";
    ctx.globalAlpha = 0.9;
    ctx.font = "22px sans-serif";
    ctx.fillText("How to win:", 460, 190);
    ctx.globalAlpha = 0.75;
    ctx.font = "18px sans-serif";
    ctx.fillText("‚Ä¢ Dodge defenders", 460, 225);
    ctx.fillText("‚Ä¢ Slide under high hits", 460, 255);
    ctx.fillText("‚Ä¢ Shield blocks one tackle", 460, 285);
    ctx.fillText("‚Ä¢ Boots = turbo sprint", 460, 315);
    ctx.fillText("‚Ä¢ Beat the high score", 460, 345);
    ctx.globalAlpha = 1;
  }

  // ---------- Update ----------
  function update(dt) {
    if (state !== "playing") return;

    // boots timer
    if (bootsT > 0) {
      bootsT -= dt;
      if (bootsT <= 0) { bootsT = 0; bootsMult = 1; }
    }

    // difficulty
    speed += speedGain * dt;
    spawnEvery = clamp(spawnBase - (speed - baseSpeed)/1400, spawnMin, spawnBase);

    // score
    scoreFloat += effectiveSpeed() * dt * 0.10;
    score = Math.floor(scoreFloat);

    // physics
    player.vy += gravity * dt;
    player.y += player.vy * dt;

    const standingH = 72;
    if (!player.sliding) player.h = standingH;

    if (player.y + player.h >= groundY) {
      player.y = groundY - player.h;
      player.vy = 0;
      player.onGround = true;
    } else player.onGround = false;

    // slide timer
    if (player.sliding) {
      player.slideT -= dt;
      if (player.slideT <= 0) {
        player.sliding = false;
        player.h = standingH;
        player.y = groundY - player.h;
      }
    }

    // spawn defenders
    spawnTimer += dt;
    if (spawnTimer >= spawnEvery) {
      spawnTimer = 0;
      spawnDefender();
    }

    // spawn powerups
    powerEvery = clamp(powerSpawnBase - (speed - baseSpeed)/2400, powerSpawnMin, powerSpawnBase);
    powerTimer += dt;
    if (powerTimer >= powerEvery) {
      powerTimer = 0;
      if (pickups.length < 2) spawnPickup();
    }

    // move defenders
    const sp = effectiveSpeed();
    for (let i = obstacles.length - 1; i >= 0; i--) {
      const o = obstacles[i];
      o.x -= sp * dt;
      if (o.x + o.w < -80) obstacles.splice(i, 1);
    }

    // move pickups
    for (let i = pickups.length - 1; i >= 0; i--) {
      const p = pickups[i];
      p.x -= sp * dt;
      if (p.x + p.w < -80) pickups.splice(i, 1);
    }

    // collisions
    const pb = playerBox();

    // pickups
    for (let i = pickups.length - 1; i >= 0; i--) {
      const p = pickups[i];
      const hb = pickupHitbox(p);
      if (aabb(pb.x,pb.y,pb.w,pb.h, hb.x,hb.y,hb.w,hb.h)) {
        applyPickup(p.type);
        pickups.splice(i, 1);
      }
    }

    // defenders
    for (let i = 0; i < obstacles.length; i++) {
      const o = obstacles[i];
      const hb = obstacleHitbox(o);
      if (aabb(pb.x,pb.y,pb.w,pb.h, hb.x,hb.y,hb.w,hb.h)) {
        if (shield) {
          shield = 0;
          obstacles.splice(i, 1);
          break;
        } else {
          gameOver();
          break;
        }
      }
    }

    // high score
    if (score > high) {
      high = score;
      localStorage.setItem("custer_dash_high", String(high));
    }

    syncUI();
  }

  // ---------- Render ----------
  function render(dt) {
    drawStadium(dt);

    // pickups
    for (const p of pickups) drawPickup(p, dt);

    // defenders
    for (const o of obstacles) drawDefender(o, dt);

    // player
    drawPlayer(dt);

    // overlays
    if (state === "menu") drawMenuOverlay();
    if (state === "paused") {
      ctx.globalAlpha = 0.75;
      ctx.fillStyle = "#050b18";
      ctx.fillRect(0, 0, W, H);
      ctx.globalAlpha = 1;
      ctx.fillStyle = "#ffffff";
      ctx.font = "42px sans-serif";
      ctx.fillText("Paused", 60, 120);
      ctx.font = "18px sans-serif";
      ctx.globalAlpha = 0.8;
      ctx.fillText("Press P to resume", 60, 152);
      ctx.globalAlpha = 1;
    }
    if (state === "gameover") {
      ctx.globalAlpha = 0.70;
      ctx.fillStyle = "#050b18";
      ctx.fillRect(0, 0, W, H);
      ctx.globalAlpha = 1;
      ctx.fillStyle = "#ffffff";
      ctx.font = "42px sans-serif";
      ctx.fillText("Game Over", 60, 120);
      ctx.font = "18px sans-serif";
      ctx.globalAlpha = 0.85;
      ctx.fillText("Press Start / Space / Click to retry", 60, 152);
      ctx.fillText("Shield blocks one hit. Boots give turbo speed.", 60, 178);
      ctx.globalAlpha = 1;
    }
  }

  // ---------- Main Loop ----------
  function loop(now) {
    const dt = Math.min(0.033, (now - tPrev) / 1000);
    tPrev = now;

    if (state !== "paused") update(dt);
    render(dt);

    requestAnimationFrame(loop);
  }

  // ---------- Init ----------
  syncUI();
  requestAnimationFrame(loop);

})();
</script>
</body>
</html>
