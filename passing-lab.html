<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Livingstonâ€™s Passing Lab â€” WFL Arcade</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .hud{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .hud span{ display:inline-block; padding:6px 10px; border:1px solid var(--border); border-radius:12px; background:#0b1220; }
    canvas{ width:100%; max-width: 980px; border:1px solid var(--border); border-radius:14px; background:#0b1220; display:block; cursor: crosshair; }
    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    button{
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background:#0b1220; color:var(--text); cursor:pointer; font-weight:900;
    }
    button:hover{ border-color: var(--link); }
    .hint{ font-size:12px; color:var(--muted); margin-top:10px; }
  </style>
</head>

<body>
  <header>
    <h1>WFL HUB</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="schedule.html">Schedule</a>
      <a href="news.html">News</a>
      <a href="quiz.html">Quiz</a>
      <a href="fan-activity.html">Fan Activity</a>
      <a href="arcade.html">Arcade</a>
    </nav>
  </header>

  <main class="wrap">
    <div class="card">
      <h2>Livingstonâ€™s Passing Lab</h2>

      <div class="hud">
        <span><strong>Score:</strong> <span id="score">0</span></span>
        <span><strong>Hits:</strong> <span id="hits">0</span></span>
        <span><strong>Misses:</strong> <span id="misses">0</span></span>
        <span><strong>Streak:</strong> <span id="streak">0</span></span>
        <span><strong>Accuracy:</strong> <span id="acc">0%</span></span>
        <span><strong>Time:</strong> <span id="time">30</span>s</span>
        <span><strong>Cooldown:</strong> <span id="cd">Ready</span></span>
        <span><strong>High:</strong> <span id="high">0</span></span>
      </div>

      <div class="btnrow">
        <button id="btnStart">Start</button>
        <button id="btnPause">Pause</button>
        <button id="btnShare">Share score</button>
      </div>

      <p class="hint">
        Click receivers to complete passes. Hit the <strong>shrinking ring</strong> for Perfect throws (big bonus).
        Clock targets add <strong>+10s</strong>. Cooldown stops spam.
      </p>

      <canvas id="c" width="980" height="520"></canvas>
      <p class="hint">New: ball trail + impact flash, Perfect Window rings, upgraded sprites.</p>
    </div>
  </main>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;

  // UI
  const scoreEl = document.getElementById("score");
  const hitsEl = document.getElementById("hits");
  const missesEl = document.getElementById("misses");
  const streakEl = document.getElementById("streak");
  const accEl = document.getElementById("acc");
  const timeEl = document.getElementById("time");
  const cdEl = document.getElementById("cd");
  const highEl = document.getElementById("high");

  const btnStart = document.getElementById("btnStart");
  const btnPause = document.getElementById("btnPause");
  const btnShare = document.getElementById("btnShare");

  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const rand = (a,b)=>a+Math.random()*(b-a);
  const choice = (arr)=>arr[(Math.random()*arr.length)|0];

  // ---- Kit (Livingston) ----
  // Livingston is WHITE: updated skin tone.
  const KIT = {
    helm: "#0b2a56",     // dark blue helmet
    jersey: "#b21f2d",   // red jersey
    pants: "#e8eef7",    // white pants
    accent: "#0b2a56",   // dark blue highlights
    skin: "#d8b08a"      // lighter skin tone
  };

  // ---- Game constants ----
  const START_TIME = 30;     // requested
  const TIME_BONUS = 10;     // clock target +10s
  const TIME_CAP = 60;       // max time w/ clocks

  const MAX_TARGETS = 4;     // less targets
  const SPAWN_BASE = 1.45;
  const SPAWN_MIN  = 0.95;

  // Throw cooldown
  const COOLDOWN = 0.42;

  // Perfect Window ring timing
  const PERFECT_LIFE = 1.05;     // seconds for ring to shrink
  const PERFECT_RADIUS_START = 34;
  const PERFECT_RADIUS_END   = 10;
  const PERFECT_THRESHOLD    = 3.5; // px tolerance for "perfect"

  // ---- State ----
  let state = "menu"; // menu | play | pause | over
  let tPrev = performance.now();

  let score = 0, hits = 0, misses = 0, streak = 0;
  let timeLeft = START_TIME;

  let spawnT = 0;
  let spawnEvery = SPAWN_BASE;

  let cdT = 0;

  let high = Number(localStorage.getItem("passing_lab_high") || 0);

  // Aim
  let aimX = W/2, aimY = H/2;

  // Targets: receiver | clock
  const targets = [];

  // Visual effects: ball trails + impact flashes + floating text
  const trails = [];
  const impacts = [];
  const floatText = [];

  function reset() {
    score = 0; hits = 0; misses = 0; streak = 0;
    timeLeft = START_TIME;
    spawnT = 0;
    spawnEvery = SPAWN_BASE;
    cdT = 0;

    targets.length = 0;
    trails.length = 0;
    impacts.length = 0;
    floatText.length = 0;

    syncUI();
  }

  function start() {
    reset();
    state = "play";
    syncUI();
  }

  function gameOver() {
    state = "over";
    if (score > high) {
      high = score;
      localStorage.setItem("passing_lab_high", String(high));
    }
    syncUI();
  }

  function togglePause() {
    if (state === "play") state = "pause";
    else if (state === "pause") state = "play";
    syncUI();
  }

  function syncUI() {
    scoreEl.textContent = String(score);
    hitsEl.textContent = String(hits);
    missesEl.textContent = String(misses);
    streakEl.textContent = String(streak);
    timeEl.textContent = String(Math.max(0, Math.ceil(timeLeft)));
    highEl.textContent = String(high);

    const attempts = hits + misses;
    const acc = attempts ? Math.round((hits/attempts)*100) : 0;
    accEl.textContent = acc + "%";

    cdEl.textContent = cdT <= 0 ? "Ready" : (cdT).toFixed(2) + "s";
  }

  // ---- Spawning ----
  function spawnReceiver() {
    const laneY = choice([185, 230, 275, 320]);
    const speed = rand(155, 225) + (START_TIME - timeLeft) * 2.0;

    const dir = Math.random() < 0.5 ? 1 : -1;
    const x = dir === 1 ? -120 : W + 120;

    targets.push({
      type: "receiver",
      x, y: laneY,
      w: 58, h: 92,
      dir,
      spd: speed,
      bob: rand(0, Math.PI*2),

      // Perfect Window ring
      ringT: 0,           // time alive for ring
      ringLife: PERFECT_LIFE,
      ringOk: true
    });
  }

  function spawnClock() {
    const y = choice([175, 215, 255]);
    const dir = Math.random() < 0.5 ? 1 : -1;
    const x = dir === 1 ? -120 : W + 120;
    const spd = rand(150, 205);

    targets.push({
      type: "clock",
      x, y,
      w: 46, h: 46,
      dir,
      spd,
      bob: rand(0, Math.PI*2)
    });
  }

  // ---- Drawing: mega-upgraded stadium + field ----
  function drawStadium(dt) {
    // Background gradient
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0, "#040812");
    g.addColorStop(0.45, "#061531");
    g.addColorStop(1, "#031226");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    // Roof band
    ctx.fillStyle = "#061026";
    ctx.fillRect(0,0,W,92);

    // Lights (with glow)
    for (let x=70; x<W; x+=220) {
      ctx.fillStyle = "#1a2b55";
      ctx.fillRect(x, 0, 14, 110);

      ctx.globalAlpha = 0.16;
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(x-54, 10, 122, 16);
      ctx.globalAlpha = 1;

      ctx.globalAlpha = 0.10;
      ctx.fillStyle = "#9ad1ff";
      ctx.fillRect(x-80, 6, 170, 26);
      ctx.globalAlpha = 1;
    }

    // Crowd bowl
    ctx.fillStyle = "#081b3d";
    ctx.fillRect(0,92,W,165);

    // Crowd dots: denser + varied + tiny banners
    ctx.globalAlpha = 0.85;
    for (let y=104; y<245; y+=15) {
      for (let x=10; x<W; x+=13) {
        const r = (x*41 + y*23) % 140;
        ctx.fillStyle =
          r < 6  ? "#f08a1a" :
          r < 18 ? "#d7e6ff" :
          r < 48 ? "#1c3c7a" :
          r < 90 ? "#14305c" :
                  "#0f274a";
        ctx.fillRect(x, y, 8, 8);
      }
    }
    ctx.globalAlpha = 1;

    // Mid ribbon board
    ctx.fillStyle = "#0b1220";
    ctx.fillRect(0,257,W,26);
    ctx.globalAlpha = 0.80;
    ctx.fillStyle = "#b21f2d";
    for (let x=0; x<W; x+=170) ctx.fillRect(x+14, 264, 140, 12);
    ctx.globalAlpha = 1;

    // Field base
    ctx.fillStyle = "#031a34";
    ctx.fillRect(0,283,W,H-283);

    // Turf texture: stripes + tiny noise specks
    ctx.globalAlpha = 0.35;
    for (let i=0;i<14;i++){
      ctx.fillStyle = i%2===0 ? "#052a56" : "#042447";
      ctx.fillRect(i*(W/14), 283, (W/14), H-283);
    }
    ctx.globalAlpha = 0.14;
    ctx.fillStyle = "#0b3a78";
    for (let i=0;i<420;i++){
      const x = (i*37)%W;
      const y = 290 + ((i*61)%(H-300));
      ctx.fillRect(x, y, 2, 2);
    }
    ctx.globalAlpha = 1;

    // Yard lines
    ctx.fillStyle = "#d7e6ff";
    ctx.globalAlpha = 0.78;
    for (let x=46; x<W; x+=92){
      ctx.fillRect(x, 304, 4, H-360);
      ctx.globalAlpha = 0.28;
      ctx.fillRect(x+12, H-44, 14, 8);
      ctx.globalAlpha = 0.78;
    }
    ctx.globalAlpha = 1;

    // Endzone band
    ctx.globalAlpha = 0.35;
    ctx.fillStyle = "#0b2a56";
    ctx.fillRect(0, H-96, W, 96);
    ctx.globalAlpha = 0.85;
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, H-96, W, 6);
    ctx.globalAlpha = 1;

    // Scoreboard box
    ctx.fillStyle = "#0b1220";
    ctx.fillRect(W-340, 18, 310, 64);
    ctx.strokeStyle = "#1f2c46";
    ctx.strokeRect(W-340, 18, 310, 64);

    ctx.fillStyle = "#ffffff";
    ctx.globalAlpha = 0.92;
    ctx.font = "16px sans-serif";
    ctx.fillText("LIVINGSTON'S PASSING LAB", W-325, 44);
    ctx.globalAlpha = 0.75;
    ctx.fillText("PERFECT WINDOWS â€¢ CLOCKS +10s", W-325, 66);
    ctx.globalAlpha = 1;

    // Cooldown meter
    const meterX = 18, meterY = 18, meterW = 190, meterH = 14;
    ctx.fillStyle = "#0b1220";
    ctx.fillRect(meterX, meterY, meterW, meterH);
    ctx.strokeStyle = "#1f2c46";
    ctx.strokeRect(meterX, meterY, meterW, meterH);

    const pct = cdT <= 0 ? 1 : clamp(1 - (cdT / COOLDOWN), 0, 1);
    ctx.globalAlpha = 0.9;
    ctx.fillStyle = pct >= 1 ? "#9ad1ff" : "#f08a1a";
    ctx.fillRect(meterX+2, meterY+2, (meterW-4)*pct, meterH-4);
    ctx.globalAlpha = 1;

    ctx.fillStyle = "#ffffff";
    ctx.globalAlpha = 0.8;
    ctx.font = "12px sans-serif";
    ctx.fillText("THROW", meterX + 6, meterY + 12);
    ctx.globalAlpha = 1;
  }

  // ---- Improved QB sprite (normal head placement, better proportions) ----
  function drawQB() {
    const x = 70, y = H-250;

    const helm = KIT.helm, red = KIT.jersey, pants = KIT.pants, blue = KIT.accent, skin = KIT.skin;

    // shadow
    ctx.globalAlpha = 0.20;
    ctx.fillStyle = "#0b0f1b";
    ctx.fillRect(x+26, H-62, 170, 16);
    ctx.globalAlpha = 1;

    // legs
    ctx.fillStyle = pants;
    ctx.fillRect(x+52, y+148, 26, 64);
    ctx.fillRect(x+88, y+148, 26, 64);

    // pant stripe
    ctx.fillStyle = blue;
    ctx.fillRect(x+82, y+148, 6, 64);

    // shoes
    ctx.fillStyle = "#0a0a0a";
    ctx.fillRect(x+48, y+202, 34, 14);
    ctx.fillRect(x+84, y+202, 34, 14);

    // torso
    ctx.fillStyle = red;
    ctx.fillRect(x+44, y+90, 104, 66);

    // shoulder pads
    ctx.fillStyle = blue;
    ctx.fillRect(x+44, y+90, 18, 14);
    ctx.fillRect(x+130, y+90, 18, 14);

    // neck
    ctx.fillStyle = skin;
    ctx.fillRect(x+92, y+80, 14, 12);

    // head/helmet positioned normally on neck
    ctx.fillStyle = helm;
    ctx.fillRect(x+96, y+42, 60, 44);

    // face opening
    ctx.fillStyle = skin;
    ctx.fillRect(x+128, y+58, 22, 18);

    // facemask
    ctx.globalAlpha = 0.70;
    ctx.fillStyle = "#d7e6ff";
    ctx.fillRect(x+122, y+70, 28, 4);
    ctx.fillRect(x+150, y+52, 4, 30);
    ctx.globalAlpha = 1;

    // arms: throw-ready
    ctx.fillStyle = skin;
    // back arm
    ctx.fillRect(x+46, y+104, 22, 18);
    // throwing arm extended
    ctx.fillRect(x+132, y+104, 46, 16);

    // gloves
    ctx.fillStyle = "#e8eef7";
    ctx.fillRect(x+170, y+104, 10, 16);

    // ball near hand (QB holding it)
    ctx.fillStyle = "#8b4c22";
    ctx.fillRect(x+182, y+104, 18, 14);
    ctx.fillStyle = "#ffffff";
    ctx.globalAlpha = 0.65;
    ctx.fillRect(x+190, y+104, 3, 14);
    ctx.globalAlpha = 1;

    // back nameplate + number 8 (cleaner)
    ctx.globalAlpha = 0.88;
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(x+64, y+100, 74, 14);
    ctx.globalAlpha = 1;
    ctx.fillStyle = red;
    ctx.font = "9px sans-serif";
    ctx.fillText("LIVINGSTON", x+67, y+110);

    ctx.globalAlpha = 0.92;
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(x+92, y+118, 22, 30);
    ctx.globalAlpha = 1;
    ctx.fillStyle = red;
    ctx.fillRect(x+96, y+122, 14, 5);
    ctx.fillRect(x+96, y+130, 14, 5);
    ctx.fillRect(x+96, y+138, 14, 5);
  }

  // ---- Receiver sprite (normal head position, more human) ----
  function drawReceiver(t, dt) {
    t.bob += dt*4.9;
    const bob = Math.sin(t.bob)*2;

    const x = t.x, y = t.y + bob;
    const helm = KIT.helm, red = KIT.jersey, pants = KIT.pants, blue = KIT.accent, skin = KIT.skin;

    // shadow
    ctx.globalAlpha = 0.16;
    ctx.fillStyle = "#0b0f1b";
    ctx.fillRect(x+12, y + t.h + 8, t.w - 24, 10);
    ctx.globalAlpha = 1;

    // legs
    ctx.fillStyle = pants;
    ctx.fillRect(x+18, y+54, 16, 38);
    ctx.fillRect(x+38, y+54, 16, 38);
    ctx.fillStyle = blue;
    ctx.fillRect(x+35, y+54, 4, 38);

    // shoes
    ctx.fillStyle = "#0a0a0a";
    ctx.fillRect(x+16, y+86, 22, 10);
    ctx.fillRect(x+36, y+86, 22, 10);

    // torso
    ctx.fillStyle = red;
    ctx.fillRect(x+14, y+26, 48, 34);
    ctx.fillStyle = blue;
    ctx.fillRect(x+14, y+26, 8, 10);
    ctx.fillRect(x+54, y+26, 8, 10);

    // neck
    ctx.fillStyle = skin;
    ctx.fillRect(x+40, y+18, 10, 10);

    // helmet (on neck, not floating)
    ctx.fillStyle = helm;
    ctx.fillRect(x+38, y+0, 30, 24);

    // face opening
    ctx.fillStyle = skin;
    ctx.fillRect(x+56, y+10, 10, 10);

    // facemask
    ctx.globalAlpha = 0.65;
    ctx.fillStyle = "#d7e6ff";
    ctx.fillRect(x+50, y+16, 14, 3);
    ctx.globalAlpha = 1;

    // arms
    ctx.fillStyle = skin;
    ctx.fillRect(x+8,  y+34, 8, 20);
    ctx.fillRect(x+62, y+34, 8, 20);

    // Perfect window rings (visual)
    const cx = x + 34;
    const cy = y + 44;
    const p = clamp(t.ringT / t.ringLife, 0, 1);
    const rNow = PERFECT_RADIUS_START + (PERFECT_RADIUS_END - PERFECT_RADIUS_START) * p;

    // soft outer ring
    ctx.globalAlpha = 0.16;
    ctx.strokeStyle = "#ffffff";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(cx, cy, rNow + 10, 0, Math.PI*2);
    ctx.stroke();
    ctx.globalAlpha = 1;

    // perfect ring (bright)
    ctx.globalAlpha = 0.85;
    ctx.strokeStyle = "#9ad1ff";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(cx, cy, rNow, 0, Math.PI*2);
    ctx.stroke();
    ctx.globalAlpha = 1;

    // headshot marker
    ctx.globalAlpha = 0.20;
    ctx.fillStyle = "#f08a1a";
    ctx.fillRect(x+58, y+4, 10, 10);
    ctx.globalAlpha = 1;
  }

  function drawClock(t, dt) {
    t.bob += dt*4.6;
    const bob = Math.sin(t.bob)*2;
    const x = t.x, y = t.y + bob;

    // glow
    ctx.globalAlpha = 0.14;
    ctx.fillStyle = "#9ad1ff";
    ctx.fillRect(x-8, y-8, t.w+16, t.h+16);
    ctx.globalAlpha = 1;

    // body
    ctx.fillStyle = "#0b1220";
    ctx.fillRect(x, y, t.w, t.h);
    ctx.strokeStyle = "#1f2c46";
    ctx.strokeRect(x, y, t.w, t.h);

    // face
    ctx.globalAlpha = 0.92;
    ctx.fillStyle = "#d7e6ff";
    ctx.fillRect(x+8, y+8, t.w-16, t.h-16);
    ctx.globalAlpha = 1;

    // hands
    ctx.strokeStyle = "#0b1220";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(x+t.w/2, y+t.h/2);
    ctx.lineTo(x+t.w/2, y+14);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x+t.w/2, y+t.h/2);
    ctx.lineTo(x+t.w-14, y+t.h/2);
    ctx.stroke();

    // +10 label
    ctx.globalAlpha = 0.95;
    ctx.fillStyle = "#f08a1a";
    ctx.fillRect(x, y+t.h-12, t.w, 12);
    ctx.fillStyle = "#0b1220";
    ctx.font = "10px sans-serif";
    ctx.fillText("+10", x+12, y+t.h-3);
    ctx.globalAlpha = 1;

    // ring
    ctx.globalAlpha = 0.28;
    ctx.strokeStyle = "#9ad1ff";
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.arc(x+t.w/2, y+t.h/2, 30, 0, Math.PI*2);
    ctx.stroke();
    ctx.globalAlpha = 1;
  }

  function drawCrosshair() {
    ctx.globalAlpha = 0.90;
    ctx.strokeStyle = "#ffffff";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(aimX, aimY, 10, 0, Math.PI*2);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(aimX-16, aimY); ctx.lineTo(aimX+16, aimY);
    ctx.moveTo(aimX, aimY-16); ctx.lineTo(aimX, aimY+16);
    ctx.stroke();
    ctx.globalAlpha = 1;
  }

  function drawOverlay() {
    if (state === "menu") {
      ctx.globalAlpha = 0.78;
      ctx.fillStyle = "#050b18";
      ctx.fillRect(0,0,W,H);
      ctx.globalAlpha = 1;

      ctx.fillStyle = "#ffffff";
      ctx.font = "54px sans-serif";
      ctx.fillText("Livingstonâ€™s Passing Lab", 60, 110);

      ctx.globalAlpha = 0.85;
      ctx.font = "18px sans-serif";
      ctx.fillText("30 seconds. Fewer targets. Cooldown throws.", 60, 148);
      ctx.fillText("Hit the shrinking ring for PERFECT throws (huge bonus).", 60, 176);
      ctx.fillText("Clock targets add +10 seconds.", 60, 204);
      ctx.fillText("Click / Space to start â€¢ P to pause", 60, 240);
      ctx.globalAlpha = 1;
    }

    if (state === "pause") {
      ctx.globalAlpha = 0.78;
      ctx.fillStyle = "#050b18";
      ctx.fillRect(0,0,W,H);
      ctx.globalAlpha = 1;
      ctx.fillStyle = "#ffffff";
      ctx.font = "50px sans-serif";
      ctx.fillText("Paused", 60, 130);
      ctx.globalAlpha = 0.85;
      ctx.font = "18px sans-serif";
      ctx.fillText("Press P or Pause to resume.", 60, 166);
      ctx.globalAlpha = 1;
    }

    if (state === "over") {
      ctx.globalAlpha = 0.78;
      ctx.fillStyle = "#050b18";
      ctx.fillRect(0,0,W,H);
      ctx.globalAlpha = 1;
      ctx.fillStyle = "#ffffff";
      ctx.font = "50px sans-serif";
      ctx.fillText("Time!", 60, 130);
      ctx.globalAlpha = 0.85;
      ctx.font = "18px sans-serif";
      ctx.fillText("Press Start to run it back.", 60, 166);
      ctx.fillText("Perfect windows + clocks = huge scores.", 60, 194);
      ctx.globalAlpha = 1;
    }
  }

  // ---- Ball trail + impact effects ----
  function addTrail(x0,y0,x1,y1) {
    trails.push({ x0,y0,x1,y1, t: 0, life: 0.18 });
  }
  function addImpact(x,y, kind) {
    impacts.push({ x,y, t: 0, life: 0.22, kind }); // kind: "hit"|"miss"|"perfect"|"clock"
  }
  function addFloat(x,y, text, color) {
    floatText.push({ x,y, text, color, t: 0, life: 0.8 });
  }

  function drawTrails(dt) {
    for (let i = trails.length-1; i>=0; i--) {
      const tr = trails[i];
      tr.t += dt;
      const p = tr.t / tr.life;
      if (p >= 1) { trails.splice(i,1); continue; }

      ctx.globalAlpha = (1 - p) * 0.75;
      ctx.strokeStyle = "#d7e6ff";
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(tr.x0, tr.y0);
      ctx.lineTo(tr.x1, tr.y1);
      ctx.stroke();

      ctx.globalAlpha = (1 - p) * 0.35;
      ctx.strokeStyle = "#9ad1ff";
      ctx.lineWidth = 7;
      ctx.beginPath();
      ctx.moveTo(tr.x0, tr.y0);
      ctx.lineTo(tr.x1, tr.y1);
      ctx.stroke();

      ctx.globalAlpha = 1;
    }
  }

  function drawImpacts(dt) {
    for (let i=impacts.length-1; i>=0; i--){
      const im = impacts[i];
      im.t += dt;
      const p = im.t / im.life;
      if (p >= 1) { impacts.splice(i,1); continue; }

      const r = 8 + p * 28;
      let col = "#ffffff";
      if (im.kind === "miss") col = "#f08a1a";
      if (im.kind === "hit") col = "#9ad1ff";
      if (im.kind === "perfect") col = "#7cffd1";
      if (im.kind === "clock") col = "#ffd447";

      ctx.globalAlpha = (1 - p) * 0.70;
      ctx.strokeStyle = col;
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.arc(im.x, im.y, r, 0, Math.PI*2);
      ctx.stroke();

      ctx.globalAlpha = (1 - p) * 0.18;
      ctx.fillStyle = col;
      ctx.beginPath();
      ctx.arc(im.x, im.y, r + 10, 0, Math.PI*2);
      ctx.fill();

      ctx.globalAlpha = 1;
    }
  }

  function drawFloatText(dt) {
    for (let i=floatText.length-1;i>=0;i--){
      const f = floatText[i];
      f.t += dt;
      const p = f.t / f.life;
      if (p >= 1) { floatText.splice(i,1); continue; }

      ctx.globalAlpha = (1 - p) * 0.95;
      ctx.fillStyle = f.color;
      ctx.font = "18px sans-serif";
      ctx.fillText(f.text, f.x, f.y - p * 34);
      ctx.globalAlpha = 1;
    }
  }

  // ---- Throw logic (cooldown + perfect windows) ----
  function canThrow() { return cdT <= 0; }
  function startCooldown() { cdT = COOLDOWN; }

  function receiverCenter(t) {
    return { cx: t.x + 34, cy: t.y + 44 };
  }

  function ringRadiusNow(t) {
    const p = clamp(t.ringT / t.ringLife, 0, 1);
    return PERFECT_RADIUS_START + (PERFECT_RADIUS_END - PERFECT_RADIUS_START) * p;
  }

  function throwAt(x,y) {
    if (state === "menu") { start(); return; }
    if (state === "over") { start(); return; }
    if (state !== "play") return;
    if (!canThrow()) return;

    startCooldown();

    // Ball trail from QB hand to click point
    const qbHandX = 70 + 200;  // approx hand position relative to QB
    const qbHandY = H - 250 + 104;
    addTrail(qbHandX, qbHandY, x, y);

    // Find target hit (topmost)
    let hitIndex = -1;
    let headshot = false;
    let perfect = false;

    for (let i = targets.length - 1; i >= 0; i--) {
      const t = targets[i];

      if (t.type === "clock") {
        if (x >= t.x && x <= t.x+t.w && y >= t.y && y <= t.y+t.h) {
          hitIndex = i;
          break;
        }
        continue;
      }

      // receiver body hitbox
      const bx = t.x + 10, by = t.y + 12;
      const bw = t.w - 20, bh = t.h - 16;

      // headshot zone
      const hx = t.x + 58, hy = t.y + 4, hw = 10, hh = 10;

      if (x >= bx && x <= bx+bw && y >= by && y <= by+bh) {
        hitIndex = i;
        headshot = (x >= hx && x <= hx+hw && y >= hy && y <= hy+hh);

        // Perfect window: click near ring radius at receiver center
        const { cx, cy } = receiverCenter(t);
        const dist = Math.hypot(x - cx, y - cy);
        const rNow = ringRadiusNow(t);
        perfect = Math.abs(dist - rNow) <= PERFECT_THRESHOLD;

        break;
      }
    }

    if (hitIndex >= 0) {
      const t = targets[hitIndex];

      if (t.type === "clock") {
        timeLeft = clamp(timeLeft + TIME_BONUS, 0, TIME_CAP);
        score += 18;
        hits += 1;
        streak += 1;

        targets.splice(hitIndex, 1);

        addImpact(x,y,"clock");
        addFloat(x+10, y-8, "+10s", "#ffd447");
        addFloat(x+10, y+14, "+18", "#d7e6ff");
        syncUI();
        return;
      }

      // points
      const basePts = 12;
      const streakBonus = Math.min(36, streak * 2);
      const headBonus = headshot ? 16 : 0;
      const perfectBonus = perfect ? 22 : 0;

      const pts = basePts + streakBonus + headBonus + perfectBonus;
      score += pts;
      hits += 1;
      streak += 1;

      // remove
      const { cx, cy } = receiverCenter(t);
      targets.splice(hitIndex, 1);

      addImpact(cx, cy, perfect ? "perfect" : "hit");
      addFloat(cx+12, cy, (perfect ? "PERFECT +" : "+") + pts, perfect ? "#7cffd1" : "#9ad1ff");

    } else {
      misses += 1;
      streak = 0;
      addImpact(x,y,"miss");
      addFloat(x+10, y, "MISS", "#f08a1a");
    }

    if (score > high) {
      high = score;
      localStorage.setItem("passing_lab_high", String(high));
    }

    syncUI();
  }

  // ---- Input ----
  canvas.addEventListener("mousemove", (e) => {
    const r = canvas.getBoundingClientRect();
    aimX = (e.clientX - r.left) * (W / r.width);
    aimY = (e.clientY - r.top)  * (H / r.height);
  });

  canvas.addEventListener("pointerdown", (e) => {
    const r = canvas.getBoundingClientRect();
    const x = (e.clientX - r.left) * (W / r.width);
    const y = (e.clientY - r.top)  * (H / r.height);
    throwAt(x,y);
  });

  window.addEventListener("keydown", (e) => {
    if (e.code === "Space") { e.preventDefault(); if (state==="menu"||state==="over") start(); }
    if (e.code === "KeyP") { e.preventDefault(); if (state==="play"||state==="pause") togglePause(); }
  });

  btnStart.addEventListener("click", () => start());
  btnPause.addEventListener("click", () => { if (state==="play"||state==="pause") togglePause(); });

  btnShare.addEventListener("click", async () => {
    const url = "https://thefutureworld2055-cyber.github.io/wfl-hub/passing-lab.html";
    const text = `I scored ${score} in Livingstonâ€™s Passing Lab ðŸˆðŸŽ¯ Beat me: ${url}`;
    if (navigator.share) {
      try { await navigator.share({ title: "Livingstonâ€™s Passing Lab", text, url }); return; } catch {}
    }
    try { await navigator.clipboard.writeText(text); alert("Copied to clipboard!"); } catch { alert(text); }
  });

  // ---- Update / Render ----
  function update(dt){
    if (state !== "play") return;

    // cooldown
    if (cdT > 0) cdT = Math.max(0, cdT - dt);

    // time
    timeLeft -= dt;
    if (timeLeft <= 0) { timeLeft = 0; gameOver(); return; }

    // spawn pacing (still "less targets")
    const progress = 1 - (timeLeft / START_TIME);
    spawnEvery = clamp(SPAWN_BASE - progress * 0.22, SPAWN_MIN, SPAWN_BASE);

    spawnT += dt;
    if (spawnT >= spawnEvery) {
      spawnT = 0;

      if (targets.length < MAX_TARGETS) {
        const clockChance = timeLeft <= 10 ? 0.22 : 0.12;
        if (Math.random() < clockChance) spawnClock();
        else spawnReceiver();
      }
    }

    // move targets
    for (let i = targets.length - 1; i >= 0; i--){
      const t = targets[i];
      t.x += t.dir * t.spd * dt;

      if (t.type === "receiver") {
        // ring timer
        t.ringT += dt;
        // after ring life, it keeps shrinking "past" perfect; still hittable, just harder
      }

      if (t.x < -180 || t.x > W + 180) {
        targets.splice(i, 1);
        if (t.type === "receiver") { misses += 1; streak = 0; }
      }
    }

    // effects timers are advanced in draw funcs, but we can prune here if needed (not necessary)
    syncUI();
  }

  function render(dt){
    drawStadium(dt);
    drawQB();

    // targets
    for (const t of targets) {
      if (t.type === "receiver") drawReceiver(t, dt);
      else drawClock(t, dt);
    }

    // effects (on top)
    drawTrails(dt);
    drawImpacts(dt);
    drawFloatText(dt);

    drawCrosshair();
    drawOverlay();
  }

  function loop(now){
    const dt = Math.min(0.033, (now - tPrev)/1000);
    tPrev = now;

    if (state !== "pause") update(dt);
    render(dt);
    requestAnimationFrame(loop);
  }

  // init
  highEl.textContent = String(high);
  syncUI();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
